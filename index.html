<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DropBocs - Ultimate</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #bf953f;
            --gold-grad: linear-gradient(135deg, #bf953f, #fcf6ba, #aa771c);
            --bg-dark: #07090c;
            --bg-card: #14181f;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.08);
            --green: #00ff88;
            --red: #ff3e3e;
            --font-main: 'Montserrat', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; user-select: none; outline: none; }
        body { background: var(--bg-dark); color: #fff; font-family: var(--font-main); overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: rgba(7, 9, 12, 0.95);
            border-bottom: 1px solid var(--border); z-index: 100;
        }
        .brand { font-weight: 900; font-size: 20px; letter-spacing: 1px; color: var(--gold); text-shadow: 0 0 15px rgba(191,149,63,0.3); }
        .balance-pill {
            display: flex; align-items: center; gap: 8px; background: var(--glass);
            padding: 6px 14px; border-radius: 50px; border: 1px solid var(--border);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* LIVE TICKER */
        .live-strip {
            height: 44px; background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 15px; overflow: hidden;
        }
        .live-label { font-size: 10px; font-weight: 900; color: #666; margin-right: 15px; display: flex; align-items: center; gap: 5px; }
        .live-feed { display: flex; gap: 15px; align-items: center; flex: 1; }
        
        .feed-item {
            display: flex; align-items: center; gap: 8px; font-size: 11px;
            background: linear-gradient(90deg, rgba(255,255,255,0.06), transparent);
            padding: 5px 10px; border-radius: 6px; border-left: 2px solid var(--gold);
            white-space: nowrap; animation: slideIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }

        /* MAIN */
        .main-container { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 110px; }
        .screen { display: none; animation: fadeUp 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* GAME */
        .online-badge {
            font-size: 11px; color: #777; text-align: center; margin-bottom: 15px;
            display: flex; justify-content: center; align-items: center; gap: 6px;
        }
        .dot { width: 6px; height: 6px; background: var(--green); border-radius: 50%; box-shadow: 0 0 8px var(--green); }
        
        .game-card {
            background: var(--bg-card); border-radius: 24px; padding: 20px;
            border: 1px solid var(--border); text-align: center;
        }
        .roulette-window {
            height: 120px; background: #0b0e11; border-radius: 16px; margin: 15px 0;
            position: relative; overflow: hidden; border: 1px solid #2a2a2a;
            box-shadow: inset 0 0 40px #000;
        }
        .pointer {
            position: absolute; top: 0; bottom: 0; left: 50%; width: 2px;
            background: #fff; z-index: 10; transform: translateX(-50%);
            box-shadow: 0 0 10px #fff;
        }
        .track { display: flex; height: 100%; align-items: center; will-change: transform; }
        .cell {
            min-width: 90px; height: 90px; margin: 0 4px; border-radius: 14px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-weight: 900; font-size: 26px; position: relative;
        }

        /* CONTROLS */
        .multipliers { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .mult-btn {
            padding: 16px; border-radius: 14px; background: rgba(255,255,255,0.04);
            border: 1px solid transparent; color: #888; font-weight: bold; transition: 0.2s;
        }
        .mult-btn.active { color: #fff; border-color: #fff; background: rgba(255,255,255,0.08); transform: scale(0.98); }
        
        .input-group {
            display: flex; gap: 8px; margin-bottom: 20px; background: rgba(0,0,0,0.4);
            padding: 6px; border-radius: 14px; border: 1px solid var(--border);
        }
        .input-group input {
            flex: 1; background: transparent; border: none; color: #fff; font-size: 18px; 
            font-weight: 900; padding: 0 10px; text-align: center;
        }
        .control-btn {
            background: rgba(255,255,255,0.1); border: none; color: #fff;
            border-radius: 10px; padding: 10px 15px; font-weight: 900; font-size: 12px;
        }

        .play-btn {
            width: 100%; padding: 20px; background: #fff; color: #000; border: none;
            border-radius: 16px; font-weight: 900; font-size: 16px; text-transform: uppercase;
            box-shadow: 0 0 20px rgba(255,255,255,0.1); transition: 0.2s;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
        .play-btn:active { transform: scale(0.96); }
        .play-btn:disabled { opacity: 0.5; animation: none; }

        /* PROFILE */
        .avatar {
            width: 110px; height: 110px; border-radius: 50%; margin: 0 auto 15px;
            border: 4px solid var(--gold); background-size: cover; background-position: center;
            box-shadow: 0 0 30px rgba(191, 149, 63, 0.25);
        }
        .stats-box { background: var(--bg-card); padding: 20px; border-radius: 20px; margin-top: 25px; border: 1px solid var(--border); }
        
        .support-btn {
            display: block; width: 100%; padding: 15px; margin-top: 15px;
            background: rgba(0, 255, 136, 0.1); color: var(--green); border: 1px solid var(--green);
            border-radius: 14px; font-weight: 800; font-size: 12px; text-transform: uppercase;
            text-decoration: none; text-align: center; transition: 0.2s;
        }
        .support-btn:active { background: var(--green); color: #000; }

        /* NAV */
        .nav-bar {
            position: fixed; bottom: 25px; left: 20px; right: 20px;
            background: rgba(20, 24, 31, 0.9); backdrop-filter: blur(15px);
            padding: 10px 0; border-radius: 25px; border: 1px solid var(--border);
            display: flex; justify-content: space-around; z-index: 1000;
        }
        .nav-item { 
            color: #555; display: flex; flex-direction: column; align-items: center; gap: 4px; 
            padding: 8px 20px; transition: 0.3s; width: 45%; border-radius: 15px;
        }
        .nav-item.active { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-item i { font-size: 20px; }
        .nav-item span { font-size: 10px; font-weight: 800; text-transform: uppercase; }

    </style>
</head>
<body>

    <div class="header">
        <div class="brand">DROPBOCS</div>
        <div class="balance-pill">
            <i class="fas fa-star" style="color: gold; font-size: 12px;"></i>
            <span id="ui-bal" style="font-weight: 800; font-size: 15px;">0</span>
        </div>
    </div>

    <div class="live-strip">
        <div class="live-label"><i class="fas fa-circle" style="color:var(--green); font-size:6px; margin-right:4px;"></i> LIVE</div>
        <div id="live-feed" class="live-feed"></div>
    </div>

    <main class="main-container">
        
        <section id="scr-game" class="screen active">
            <div class="online-badge">
                <div class="dot"></div> <span id="online-count">Loading...</span> 
            </div>

            <div class="game-card">
                <div class="roulette-window">
                    <div class="pointer"></div>
                    <div id="track" class="track"></div>
                </div>

                <div class="multipliers">
                    <div class="mult-btn" onclick="setMult(2)" id="btn-2">x2</div>
                    <div class="mult-btn" onclick="setMult(3)" id="btn-3">x3</div>
                    <div class="mult-btn" onclick="setMult(5)" id="btn-5">x5</div>
                    <div class="mult-btn" onclick="setMult(50)" id="btn-50" style="color: var(--gold);">x50</div>
                </div>

                <div class="input-group">
                    <button class="control-btn" onclick="modBet(0.5)">/2</button>
                    <input type="number" id="bet-input" value="100">
                    <button class="control-btn" onclick="modBet(2)">x2</button>
                </div>

                <button id="spin-btn" class="play-btn" onclick="spin()">КРУТИТЬ</button>
            </div>
        </section>

        <section id="scr-profile" class="screen">
            <div style="text-align: center;">
                <div class="avatar" id="u-avatar" style="background-image: url('https://img.icons8.com/3d-fluency/200/user-male-circle.png');"></div>
                <h2 id="u-name">Player</h2>
                <div id="u-id" style="font-size: 11px; opacity: 0.5; margin-top: 5px;">ID: ...</div>
            </div>

            <div class="stats-box">
                <h4 style="margin-bottom: 15px; color: #888;">ПРОМОКОД</h4>
                <div class="input-group" style="margin-bottom: 5px;">
                    <input type="text" id="promo-code" placeholder="Введите код">
                    <button class="control-btn" style="background: #fff; color: #000;" onclick="checkPromo()">OK</button>
                </div>
                <div id="promo-status" style="font-size: 11px; height: 15px;"></div>

                <a href="#" onclick="openSupport()" class="support-btn">
                    <i class="fas fa-headset"></i> Тех. Поддержка
                </a>
            </div>
        </section>

    </main>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="nav('game', this)">
            <i class="fas fa-gamepad"></i> <span>Играть</span>
        </div>
        <div class="nav-item" onclick="nav('profile', this)">
            <i class="fas fa-user-astronaut"></i> <span>Профиль</span>
        </div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ⚠️ ВАЖНО: ВСТАВЬ СВОЙ КОНФИГ НИЖЕ ⚠️
        const firebaseConfig = {
           apiKey: "AIzaSyD...", 
           authDomain: "...", 
           databaseURL: "...", 
           projectId: "...", 
           storageBucket: "...", 
           messagingSenderId: "...", 
           appId: "..." 
        };

        // --- ЛОГИКА ---
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch(e) { console.error("Firebase init failed", e); }

        let user = { 
            id: 'guest', name: 'Guest', bal: 1000, 
            usedPromos: [] // Храним использованные коды
        };
        
        const PATTERN = [2,3,2,5,2,3,2,5,2,3,2,50,2,3,2,5,2,3,2,3,2,5,2,3,2,50,2,5,2,3];
        let game = { spinning: false, sel: null };

        // 1. ИНИЦИАЛИЗАЦИЯ
        function init() {
            if(tg.initDataUnsafe?.user) {
                user.id = tg.initDataUnsafe.user.id.toString();
                user.name = tg.initDataUnsafe.user.first_name;
                if(tg.initDataUnsafe.user.photo_url) {
                    document.getElementById('u-avatar').style.backgroundImage = `url(${tg.initDataUnsafe.user.photo_url})`;
                }
            } else {
                // Для теста в браузере
                user.id = localStorage.getItem('emu_id') || 'testuser_' + Math.floor(Math.random()*1000);
                localStorage.setItem('emu_id', user.id);
            }

            document.getElementById('u-name').innerText = user.name;
            document.getElementById('u-id').innerText = "ID: " + user.id;

            if(db) {
                db.ref('users/' + user.id).on('value', snap => {
                    const val = snap.val();
                    if(val) {
                        user.bal = val.bal;
                        if(val.usedPromos) user.usedPromos = val.usedPromos;
                    } else {
                        save();
                    }
                    updateUI();
                });
            }

            renderTrack();
            initLive();
            initOnline();
        }

        function save() {
            if(db) db.ref('users/' + user.id).update({
                bal: user.bal,
                name: user.name,
                usedPromos: user.usedPromos || []
            });
            updateUI();
        }

        function updateUI() {
            document.getElementById('ui-bal').innerText = Math.floor(user.bal).toLocaleString();
        }

        // 2. ИГРОВОЙ ДВИЖОК
        function renderTrack() {
            const track = document.getElementById('track');
            track.innerHTML = '';
            for(let i=0; i<100; i++) {
                let v = PATTERN[i % PATTERN.length];
                let c = '#2c3e50';
                if(v==3) c = 'rgba(0,255,136,0.15); color:#00ff88; border:1px solid #00ff88';
                if(v==5) c = 'rgba(255,62,62,0.15); color:#ff3e3e; border:1px solid #ff3e3e';
                if(v==50) c = '#bf953f; color:#000';
                
                let d = document.createElement('div');
                d.className = 'cell';
                d.style.cssText = `background:${c}`;
                d.innerHTML = v;
                track.appendChild(d);
            }
        }

        function setMult(m) {
            if(game.spinning) return;
            game.sel = m;
            document.querySelectorAll('.mult-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+m).classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        function modBet(x) {
            let el = document.getElementById('bet-input');
            el.value = Math.floor(Math.max(1, el.value * x));
        }

        function spin() {
            let bet = parseInt(document.getElementById('bet-input').value);
            if(game.spinning) return;
            if(!game.sel) { tg.showAlert("Выберите множитель!"); return; }
            if(bet > user.bal) { tg.showAlert("Недостаточно средств"); return; }
            if(isNaN(bet) || bet <= 0) return;

            game.spinning = true;
            user.bal -= bet;
            save();
            
            let btn = document.getElementById('spin-btn');
            btn.disabled = true;
            btn.innerText = "КРУТИМ...";

            // РАСЧЕТ
            let offsetRnd = Math.floor(Math.random() * 30);
            let targetIdx = 65 + offsetRnd; 
            let winVal = PATTERN[targetIdx % PATTERN.length];
            
            let cellW = 98; 
            let trackW = document.querySelector('.roulette-window').offsetWidth;
            let finalPos = (targetIdx * cellW) - (trackW / 2) + (cellW/2);

            let tr = document.getElementById('track');
            tr.style.transition = "transform 5s cubic-bezier(0.15, 0, 0.10, 1)";
            tr.style.transform = `translateX(-${finalPos}px)`;

            setTimeout(() => {
                let winAmt = 0;
                if(winVal === game.sel) {
                    winAmt = bet * winVal;
                    user.bal += winAmt;
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showPopup({title:'ПОБЕДА!', message:`+${winAmt} Stars`});
                    addLiveItem(user.id, winAmt, true);
                } else {
                    tg.HapticFeedback.notificationOccurred('error');
                }
                save();

                setTimeout(() => {
                    tr.style.transition = 'none';
                    tr.style.transform = 'translateX(0)';
                    game.spinning = false;
                    btn.disabled = false;
                    btn.innerText = "КРУТИТЬ";
                }, 1500);

            }, 5100);
        }

        // 3. УМНЫЙ ОНЛАЙН (Фикс прыжков)
        function initOnline() {
            const el = document.getElementById('online-count');
            
            // Определяем базу по времени суток
            const h = new Date().getHours();
            let current = (h >= 1 && h < 8) ? 120 : 550; // Ночь: 120, День: 550

            setInterval(() => {
                // Плавный дрейф (+/- 1..3 человека)
                let change = Math.floor(Math.random() * 5) - 2; 
                current += change;
                
                // Границы чтобы не ушло в ноль
                if(current < 40) current = 45;
                if(current > 900) current = 890;

                el.innerText = `${current} playing now`;
            }, 4000);
        }

        // 4. LIVE ЛЕНТА
        function initLive() {
            setInterval(() => {
                let r = Math.random();
                if(r > 0.4) return; // Не спамим слишком часто
                
                let fakeAmt = (Math.floor(Math.random()*5)+1) * 50; 
                if(Math.random() > 0.95) fakeAmt = 500; // Редко большой

                let fakeId = Math.floor(Math.random()*899999) + 100000;
                addLiveItem(fakeId, fakeAmt);
            }, 2000);
        }

        function addLiveItem(id, amt, isMe=false) {
            let strip = document.getElementById('live-feed');
            let div = document.createElement('div');
            div.className = 'feed-item';
            div.style.borderLeftColor = isMe ? '#00ff88' : '#bf953f';
            
            let name = isMe ? "YOU" : `ID: ${id.toString().slice(0,4)}**`;
            div.innerHTML = `<i class="fas fa-user-circle" style="opacity:0.5"></i> ${name} <b style="color:#fff; margin-left:5px">+${amt}</b>`;
            
            strip.prepend(div);
            if(strip.children.length > 4) strip.lastElementChild.remove();
        }

        // 5. ПРОМОКОДЫ И ПОДДЕРЖКА
        function checkPromo() {
            const inp = document.getElementById('promo-code');
            const stat = document.getElementById('promo-status');
            const code = inp.value.trim();
            
            if(!code) return;

            // Защита от повтора
            if(user.usedPromos && user.usedPromos.includes(code.toLowerCase())) {
                stat.style.color = 'var(--red)';
                stat.innerText = "Код уже активирован!";
                return;
            }

            let reward = 0;
            // ⚠️ ТВОЙ КОД ЗДЕСЬ
            if(code === "TestRunAdmin7072010Roma") reward = 1000000;
            else if(code.toUpperCase() === "START") reward = 500;
            else if(code.toUpperCase() === "DROP2024") reward = 200;

            if(reward > 0) {
                user.bal += reward;
                if(!user.usedPromos) user.usedPromos = [];
                user.usedPromos.push(code.toLowerCase()); // Запоминаем
                save();
                
                stat.style.color = 'var(--green)';
                stat.innerText = `Успешно! +${reward.toLocaleString()} Stars`;
                inp.value = "";
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                stat.style.color = 'var(--red)';
                stat.innerText = "Неверный код";
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function openSupport() {
            // Нативное открытие телеграм ссылки
            tg.openTelegramLink("https://t.me/nasjsa");
        }

        // НАВИГАЦИЯ
        function nav(s, btn) {
            document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
            document.getElementById('scr-'+s).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
        }

        window.onload = init;
    </script>
</body>
</html>
